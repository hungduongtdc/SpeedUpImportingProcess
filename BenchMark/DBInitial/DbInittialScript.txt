CREATE TYPE AttendanceCsvType AS TABLE
(
[Index] INT, StudentId INT, AttendanceDate DATE, AttendanceCode INT
);
go
CREATE TABLE [dbo].[Attendance](
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[AttendanceDate] [date] NOT NULL,
	[AttendanceCode] [int] NOT NULL,
	[StudentId] [int] NOT NULL,
 CONSTRAINT [pk_Attendance] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)
go
IF OBJECT_ID('[dbo].[ImportAttendance]') IS NULL
 EXECUTE ('CREATE PROCEDURE [dbo].[ImportAttendance] as select 1');
GO
ALTER PROCEDURE [dbo].[ImportAttendance]
AS
BEGIN
 SET NOCOUNT ON;

	 IF OBJECT_ID('tempdb..#temp') IS NULL
	  CREATE TABLE #temp([Index] INT, StudentId INT, AttendanceDate DATE, AttendanceCode INT);

	  IF OBJECT_ID('tempdb..#importLog') IS NULL
		 CREATE TABLE #importLog(LineIndex INT, LogDetail VARCHAR(100));


		 DELETE 
		 #temp 
		 OUTPUT deleted.[Index],'We don''t like these index' INTO #importLog
		 WHERE [Index] % 100  = 0;



	 INSERT INTO Attendance(StudentId,AttendanceDate,AttendanceCode)
	 SELECT StudentId,AttendanceDate,AttendanceCode FROM #temp;

	 SELECT* FROM #importLog;
END;
GO
USE TestDB;
GO
IF OBJECT_ID('[dbo].[ImportAttendance_TableValued]') IS NULL
 EXECUTE ('CREATE PROCEDURE [dbo].[ImportAttendance_TableValued] as select 1');
GO
ALTER PROCEDURE [dbo].[ImportAttendance_TableValued]
(
	@data AttendanceCsvType readonly
)
AS
BEGIN
 SET NOCOUNT ON;


  INSERT INTO Attendance(StudentId,AttendanceDate,AttendanceCode)
  SELECT StudentId,AttendanceDate,AttendanceCode FROM @data;

END;
GO